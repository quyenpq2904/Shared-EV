version: '3.8'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - shared-ev-network

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    depends_on: [zookeeper]
    ports:
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - shared-ev-network

  redis:
    image: redis:alpine
    networks:
      - shared-ev-network

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME:-shared_ev_db}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - shared-ev-network

  auth-service:
    build:
      context: .
      args: { APP_NAME: auth-service }
    environment:
      APP_NAME: auth-service
      NODE_ENV: production
      PORT: 3001
      GRPC_URL: 0.0.0.0:50051
      CLIENT_URL: ${CLIENT_URL}
      DATABASE_TYPE: ${DATABASE_TYPE}
      DATABASE_HOST: postgres
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: auth_db
      DATABASE_SYNCHRONIZE: 'true'
      JWT_SECRET: ${JWT_SECRET}
      JWT_TOKEN_EXPIRES_IN: ${JWT_TOKEN_EXPIRES_IN}
      REFRESH_SECRET: ${REFRESH_SECRET}
      REFRESH_TOKEN_EXPIRES_IN: ${REFRESH_TOKEN_EXPIRES_IN}
      FORGOT_SECRET: ${FORGOT_SECRET}
      FORGOT_TOKEN_EXPIRES_IN: ${FORGOT_TOKEN_EXPIRES_IN}
      CONFIRM_EMAIL_SECRET: ${CONFIRM_EMAIL_SECRET}
      CONFIRM_EMAIL_TOKEN_EXPIRES_IN: ${CONFIRM_EMAIL_TOKEN_EXPIRES_IN}
      KAFKA_BROKER: kafka:9092
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on: [kafka, redis, postgres]
    networks:
      - shared-ev-network

  user-service:
    build:
      context: .
      args: { APP_NAME: user-service }
    environment:
      NODE_ENV: production
      PORT: 3002
      DATABASE_TYPE: ${DATABASE_TYPE}
      DATABASE_HOST: postgres
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: user_db
      DATABASE_SYNCHRONIZE: 'true'
      KAFKA_BROKER: kafka:9092
      KAFKA_GROUP_ID: user-prod-group
      GRPC_URL: 0.0.0.0:50052
    depends_on: [kafka, postgres]
    networks:
      - shared-ev-network

  email-service:
    build:
      context: .
      args: { APP_NAME: email-service }
    environment:
      APP_NAME: email-service
      NODE_ENV: production
      PORT: 3003
      KAFKA_BROKER: kafka:9092
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USER: ${MAIL_USER}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      DEFAULT_EMAIL: ${DEFAULT_EMAIL}
      DEFAULT_NAME: ${DEFAULT_NAME}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on: [kafka, redis]
    networks:
      - shared-ev-network

  api-gateway:
    build:
      context: .
      args: { APP_NAME: api-gateway }
    ports:
      - "6789:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      AUTH_GRPC_URL: auth-service:50051
      USER_GRPC_URL: user-service:50052
    depends_on: [auth-service, user-service]
    networks:
      - shared-ev-network

volumes:
  pgdata:

networks:
  shared-ev-network:
    driver: bridge